<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOLIDX - Videollamada</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://8x8.vc/external_api.js"></script>
</head>
<body>
  <header>
    <img src="logo_universidad.png" alt="Logo Universidad" class="logo" />
    <div class="header-center">
      <h1>SOLIDX</h1>
      <p>"La inclusión no es llevar las personas a lo que ya existe; es crear nuevos y mejores espacios para todos"</p>
    </div>
  </header>

  <main>
    <div class="join-container">
      <div class="row">
        <input id="nombre" type="text" placeholder="Tu nombre" />
        <input id="sala" type="text" placeholder="Nombre de la sala" />
      </div>

      <div class="role-card">
        <div class="role-title">¿Cuál es tu rol para esta reunión?</div>
        <label class="role-option">
          <input type="radio" name="rol" id="rolOyente" value="oyente" checked />
          <span>Soy oyente</span>
        </label>
        <label class="role-option">
          <input type="radio" name="rol" id="rolNoOyente" value="no_oyente" />
          <span>No oyente (activar traductor)</span>
        </label>
      </div>

      <div class="actions">
        <button id="btnEntrar">Entrar</button>
        <button id="btnInvitar" class="secondary">Invitar</button>
      </div>
    </div>

    <div id="meet" class="meet"></div>
  </main>

  <footer>
    <p>© 2025 SOLIDX — Videollamadas con IA</p>
  </footer>

  <script>
    const APP_ID = "vpaas-magic-cookie-47b629c2cf8a4db3a9373961402974c0";
    const domain = "8x8.vc";

    // Lee ?room= de la URL y autocompleta
    const params = new URLSearchParams(window.location.search);
    const roomFromUrl = params.get("room");
    if (roomFromUrl) {
      document.getElementById("sala").value = roomFromUrl;
    }

    document.getElementById("btnInvitar").addEventListener("click", async () => {
      const salaInput = document.getElementById("sala").value.trim() || "demo";
      const origin = window.location.origin;
      // Link de invitación válido: /join/<room>
      const inviteUrl = `${origin}/join/${encodeURIComponent(salaInput)}`;

      try {
        await navigator.clipboard.writeText(inviteUrl);
        alert("Link de invitación copiado:\n" + inviteUrl);
      } catch {
        // Fallback
        prompt("Copia el enlace y compártelo:", inviteUrl);
      }
    });

    document.getElementById("btnEntrar").addEventListener("click", async () => {
      const nombre = document.getElementById("nombre").value.trim() || "Invitado";
      const salaInput = document.getElementById("sala").value.trim() || "demo";
      const roomName = `${APP_ID}/${salaInput}`;

      const esNoOyente = document.getElementById("rolNoOyente").checked;
      const traductorInicialActivo = esNoOyente;

      try {
        const res = await fetch(`/api/token?room=${encodeURIComponent(salaInput)}&name=${encodeURIComponent(nombre)}&moderator=true`);
        const data = await res.json();

        if (!data.token) {
          alert("No se pudo obtener el token del servidor.");
          return;
        }

        const options = {
          roomName,
          jwt: data.token,
          parentNode: document.getElementById("meet"),
          configOverwrite: {
            prejoinPageEnabled: true,
            defaultLanguage: "es",
            disableSimulcast: true,
            constraints: { video: { height: { ideal: 480 }, width: { ideal: 720 } } },
          },
          interfaceConfigOverwrite: {
            SHOW_JITSI_WATERMARK: false,
            SHOW_CHROME_EXTENSION_BANNER: false,
            DEFAULT_BACKGROUND: "#f0f0f0"
          },
          userInfo: { displayName: nombre }
        };

        const api = new JitsiMeetExternalAPI(domain, options);
        api.executeCommand("subject", "Videollamada SOLIDX");

        // (si en el futuro vuelves a integrar tu botón de traductor, aquí es donde lo habilitas)
        // if (traductorInicialActivo) { ... }

      } catch (err) {
        console.error("Error al conectar con el servidor:", err);
        alert("Error al conectar con el servidor. Revisa la consola.");
      }
    });
  </script>
</body>
</html>
